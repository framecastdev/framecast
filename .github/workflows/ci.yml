name: CI

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  packages: read  # Required for GHCR container auth

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # Rust toolchain location in CI image
  RUSTUP_HOME: /opt/rust/rustup
  CARGO_HOME: /opt/rust/cargo

jobs:
  ci:
    name: CI Pipeline
    runs-on: self-hosted
    container:
      image: ghcr.io/framecastdev/framecast-ci:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres  # pragma: allowlist secret
          POSTGRES_DB: framecast_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      localstack:
        image: localstack/localstack:latest
        env:
          SERVICES: ses
          DEBUG: "0"
        options: >-
          --health-cmd "curl -f http://localhost:4566/_localstack/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          --health-start-period 30s

    env:
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/framecast_test  # pragma: allowlist secret

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "ci"

      - name: Check formatting
        run: just fmt-check

      - name: Run clippy
        run: just ci-clippy

      - name: Run migrations
        run: just ci-migrate

      - name: Run tests
        run: just ci-test

      - name: Setup LocalStack SES identities
        env:
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test  # pragma: allowlist secret
          AWS_DEFAULT_REGION: us-east-1
          AWS_ENDPOINT_URL: http://localstack:4566
        run: just ci-setup-ses

      - name: Run SES integration tests
        env:
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test  # pragma: allowlist secret
          AWS_DEFAULT_REGION: us-east-1
          AWS_ENDPOINT_URL: http://localstack:4566
          EMAIL_PROVIDER: ses
          FROM_EMAIL: invitations@framecast.app
          EMAIL_ENABLED: "true"
        run: just ci-test-integration-ses

  infra-validate:
    name: Validate Infrastructure
    runs-on: self-hosted
    container:
      image: ghcr.io/framecastdev/framecast-ci:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Format check OpenTofu
        run: |
          cd infra/opentofu
          tofu fmt -check -recursive

      - name: Initialize OpenTofu
        run: just infra-init

      - name: Validate OpenTofu configuration
        run: just infra-validate

  build-lambda:
    name: Build Lambda
    runs-on: self-hosted
    container:
      image: ghcr.io/framecastdev/framecast-ci:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "ci"

      - name: Build Lambda
        run: just lambda-build

      - name: Verify artifact exists
        run: |
          if [ ! -f target/lambda/lambda/bootstrap.zip ]; then
            echo "Lambda artifact not found!"
            exit 1
          fi
          ls -la target/lambda/lambda/bootstrap.zip
          echo "Lambda artifact size: $(du -h target/lambda/lambda/bootstrap.zip | cut -f1)"

  e2e-tests:
    name: E2E Tests
    runs-on: self-hosted
    needs: [ci]
    container:
      image: ghcr.io/framecastdev/framecast-ci:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres  # pragma: allowlist secret
          POSTGRES_DB: framecast_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      localstack:
        image: localstack/localstack:latest
        env:
          SERVICES: ses
          DEBUG: "0"
        options: >-
          --health-cmd "curl -f http://localhost:4566/_localstack/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          --health-start-period 30s

    env:
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/framecast_test  # pragma: allowlist secret
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test  # pragma: allowlist secret
      AWS_DEFAULT_REGION: us-east-1
      AWS_ENDPOINT_URL: http://localstack:4566
      JWT_SECRET: test-e2e-secret-key-for-ci-only-0  # pragma: allowlist secret
      EMAIL_PROVIDER: ses
      FROM_EMAIL: invitations@framecast.app
      EMAIL_ENABLED: "true"
      # Required by Config::from_env() but unused in E2E context
      SUPABASE_URL: http://localhost:54321
      SUPABASE_ANON_KEY: test-anon-key
      SUPABASE_SERVICE_ROLE_KEY: test-service-role-key
      ANTHROPIC_API_KEY: test-anthropic-key
      INNGEST_EVENT_KEY: test-inngest-key
      INNGEST_SIGNING_KEY: test-inngest-signing-key
      RUNPOD_API_KEY: test-runpod-key
      RUNPOD_ENDPOINT_ID: test-endpoint-id
      S3_BUCKET_OUTPUTS: framecast-outputs-dev
      S3_BUCKET_ASSETS: framecast-assets-dev

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "ci"

      - name: Setup LocalStack SES identities
        run: just ci-setup-ses

      - name: Run database migrations
        run: just ci-migrate

      - name: Build and start API server
        shell: bash
        run: just ci-start-api

      - name: Install Python E2E dependencies
        run: just install-python-deps

      - name: Run Python E2E tests
        env:
          TEST_LOCAL_API_URL: http://localhost:3000
          TEST_LOCALSTACK_SES_URL: http://localstack:4566
          TEST_DATABASE_URL: postgresql://postgres:postgres@postgres:5432/framecast_test  # pragma: allowlist secret
        run: just ci-test-e2e
